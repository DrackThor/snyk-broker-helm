suite: test broker deployment with external secrets
chart:
  version: 0.0.0
templates:
  - broker_deployment.yaml
values:
  - ./fixtures/default_values.yaml
  - ./fixtures/default_values_external_secret.yaml

tests:
  - it: should set an external GITHUB_TOKEN secret
    set:
      scmType: github-com
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[3].name
          value: BROKER_TOKEN
      - equal:
          path: spec.template.spec.containers[0].env[4].name
          value: GITHUB_TOKEN
      - equal:
          path: spec.template.spec.containers[0].env[3].valueFrom.secretKeyRef.name
          value: my-broker-token-secret
      - equal:
          path: spec.template.spec.containers[0].env[3].valueFrom.secretKeyRef.key
          value: my-token
      - equal:
          path: spec.template.spec.containers[0].env[4].valueFrom.secretKeyRef.name
          value: my-target-token-secret
      - equal:
          path: spec.template.spec.containers[0].env[4].valueFrom.secretKeyRef.key
          value: my-token
